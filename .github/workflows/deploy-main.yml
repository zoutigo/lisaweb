name: Deploy to o2switch (Next.js standalone + Prisma)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run type-check

      - name: Build (standalone)
        run: npm run build

      - name: Prepare deploy bundle
        run: |
          set -euo pipefail
          rm -rf deploy
          mkdir -p deploy/.next
          cp -r .next/standalone/* deploy/
          cp -r .next/static deploy/.next/static
          cp -r public deploy/public
          cp package.json package-lock.json deploy/
          mkdir -p deploy/prisma
          cp -r prisma/* deploy/prisma/
          if [ -f server.js ]; then cp server.js deploy/server.js; fi

      - name: Install tools (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get runner public IP
        id: ip
        uses: haythem/public-ip@v1.3

      - name: Debug cPanel host
        shell: bash
        env:
          CPANEL_HOST: ${{ secrets.CPANEL_HOST }}
        run: |
          set -e
          echo "CPANEL_HOST=$CPANEL_HOST"
          echo | openssl s_client -connect "${CPANEL_HOST}:2083" -servername "${CPANEL_HOST}" 2>/dev/null | openssl x509 -noout -subject -issuer -ext subjectAltName | sed -n '1,120p'

      - name: Check cPanel port reachability (2083)
        shell: bash
        env:
          CPANEL_HOST: ${{ secrets.CPANEL_HOST }}
        run: |
          set -euo pipefail
          echo "nc to ${CPANEL_HOST}:2083"
          nc -vz -w 5 "$CPANEL_HOST" 2083 || true

      - name: Whitelist runner IP on o2switch (cPanel)
        shell: bash
        env:
          # cPanel API access
          CPANEL_HOST: ${{ secrets.CPANEL_HOST }}
          CPANEL_USER: ${{ secrets.CPANEL_USER }}
          CPANEL_PASSWORD: ${{ secrets.CPANEL_PASSWORD }}

          # keep your home/static IP
          IP_TO_KEEP: ${{ secrets.IP_TO_KEEP }}

          # runner IP
          RUNNER_IP: ${{ steps.ip.outputs.ipv4 }}
        run: |
          set -euo pipefail
          ENDPOINT='frontend/o2switch/o2switch-ssh-whitelist/index.live.php'

          AUTH_STR="Basic $(echo -n "${CPANEL_USER}:${CPANEL_PASSWORD}" | base64 -w0)"

          if [ -z "${IP_TO_KEEP:-}" ]; then
            echo "IP_TO_KEEP is missing (refusing to modify whitelist)."
            exit 1
          fi
          if [ -z "${RUNNER_IP:-}" ]; then
            echo "RUNNER_IP is empty (no IPv4 detected)."
            exit 1
          fi

          echo "Runner IP: ${RUNNER_IP}"
          echo "IP to keep: ${IP_TO_KEEP}"
          fetch() {
            curl -4 -sS -v --connect-timeout 10 --max-time 20 -H "Authorization: $AUTH_STR" \
              "https://${CPANEL_HOST}:2083/${ENDPOINT}?$1"
          }

          echo "Fetching whitelist..."
          RAW=""
          for i in 1 2 3; do
            RAW="$(fetch "r=list")" && break || true
            echo "Retry list ($i)..."
            sleep 5
          done
          if [ -z "$RAW" ]; then
            echo "Unable to fetch whitelist after retries"
            exit 1
          fi

          echo "$RAW" | jq -e . >/dev/null
          IPS="$(echo "$RAW" | jq -r '.data.list[]?.address' | sort -u || true)"

          echo "Current whitelist IPs:"
          echo "$IPS" | sed '/^$/d' || true

          # Remove everything except IP_TO_KEEP and RUNNER_IP
          for address in $IPS; do
            if [[ "$address" == "$IP_TO_KEEP" ]]; then
              echo "Keeping IP_TO_KEEP: $address"
              continue
            fi
            if [[ "$address" == "$RUNNER_IP" ]]; then
              echo "Keeping RUNNER_IP already present: $address"
              continue
            fi

            echo "Removing old IP: $address (in/out)"
            fetch "r=remove&address=${address}&direction=in&port=22" || true
            sleep 2
            fetch "r=remove&address=${address}&direction=out&port=22" || true
            sleep 2
          done

          echo "Adding RUNNER_IP on port 22 (in/out)..."
          echo "[ADD IN]"
          fetch "r=add&address=${RUNNER_IP}&direction=in&port=22" || true

          sleep 2

          echo "[ADD OUT]"
          fetch "r=add&address=${RUNNER_IP}&direction=out&port=22" || true

      - name: Show whitelist after update
        shell: bash
        env:
          CPANEL_HOST: ${{ secrets.CPANEL_HOST }}
          CPANEL_USER: ${{ secrets.CPANEL_USER }}
          CPANEL_PASSWORD: ${{ secrets.CPANEL_PASSWORD }}
          RUNNER_IP: ${{ steps.ip.outputs.ipv4 }}
        run: |
          set -euo pipefail
          ENDPOINT='frontend/o2switch/o2switch-ssh-whitelist/index.live.php'
          AUTH_STR="Basic $(echo -n "${CPANEL_USER}:${CPANEL_PASSWORD}" | base64 -w0)"
          RAW="$(curl -sS -H "Authorization: $AUTH_STR" \
            "https://${CPANEL_HOST}:2083/${ENDPOINT}?r=list")"
          echo "$RAW" | jq -e . >/dev/null
          echo "Whitelist after update:"
          echo "$RAW" | jq -r '.data.list[]?.address'
          echo "Runner IP expected: ${RUNNER_IP}"
          echo "Full response:"
          echo "$RAW"

      - name: Diagnose SSH reachability
        shell: bash
        env:
          O2_SSH_HOST: ${{ secrets.O2_SSH_HOST }}
          O2_SSH_PORT: ${{ secrets.O2_SSH_PORT }}
        run: |
          set -euo pipefail
          echo "Resolving host..."
          getent hosts "$O2_SSH_HOST" || true
          echo "nslookup:"
          nslookup "$O2_SSH_HOST" || true
          echo "nc probe:"
          nc -vz -w 5 "$O2_SSH_HOST" "$O2_SSH_PORT" || true

      - name: Prepare SSH key
        shell: bash
        env:
          O2_SSH_KEY: ${{ secrets.O2_SSH_KEY }}
          O2_SSH_HOST: ${{ secrets.O2_SSH_HOST }}
          O2_SSH_PORT: ${{ secrets.O2_SSH_PORT }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf '%s\n' "$O2_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          echo "Keyscan (with retries, up to ~5 min) to ${O2_SSH_HOST}:${O2_SSH_PORT}..."
          ok=0
          for i in {1..30}; do
            echo "ssh-keyscan attempt $i..."
            if ssh-keyscan -v -4 -T 10 -p "${O2_SSH_PORT}" "${O2_SSH_HOST}" >> ~/.ssh/known_hosts 2>/tmp/sshkeyscan.err; then
              ok=1
              break
            fi
            echo "ssh-keyscan stderr:"
            cat /tmp/sshkeyscan.err || true
            sleep 10
          done
          if [ "$ok" -ne 1 ]; then
            echo "ssh-keyscan failed after retries:"
            cat /tmp/sshkeyscan.err || true
            exit 1
          fi

      - name: Wait for whitelist to be effective
        shell: bash
        env:
          O2_SSH_HOST: ${{ secrets.O2_SSH_HOST }}
          O2_SSH_USER: ${{ secrets.O2_SSH_USER }}
          O2_SSH_PORT: ${{ secrets.O2_SSH_PORT }}
        run: |
          set -euo pipefail
          for i in {1..30}; do
            echo "SSH check attempt $i..."
            if ssh -4 -o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=5 -p "${O2_SSH_PORT}" \
              "${O2_SSH_USER}@${O2_SSH_HOST}" "echo OK" >/dev/null 2>&1; then
              echo "SSH is reachable."
              exit 0
            fi
            sleep 10
          done
          echo "SSH still not reachable after 5 min."
          exit 1

      - name: Test SSH connectivity
        shell: bash
        env:
          O2_SSH_HOST: ${{ secrets.O2_SSH_HOST }}
          O2_SSH_USER: ${{ secrets.O2_SSH_USER }}
          O2_SSH_PORT: ${{ secrets.O2_SSH_PORT }}
        run: |
          set -euo pipefail
          ssh -4 -vvv -o BatchMode=yes -o ConnectTimeout=10 -p "${O2_SSH_PORT}" \
            "${O2_SSH_USER}@${O2_SSH_HOST}" "echo OK && hostname && whoami"

      - name: Deploy via rsync (bundle)
        shell: bash
        env:
          O2_SSH_HOST: ${{ secrets.O2_SSH_HOST }}
          O2_SSH_USER: ${{ secrets.O2_SSH_USER }}
          O2_SSH_PORT: ${{ secrets.O2_SSH_PORT }}
          O2_TARGET_DIR: ${{ secrets.O2_TARGET_DIR }}
        run: |
          set -euo pipefail
          rsync -az --delete \
            -e "ssh -4 -p ${O2_SSH_PORT}" \
            deploy/ \
            "${O2_SSH_USER}@${O2_SSH_HOST}:${O2_TARGET_DIR}/"

      - name: Install prod deps + migrate + restart (server)
        shell: bash
        env:
          O2_SSH_HOST: ${{ secrets.O2_SSH_HOST }}
          O2_SSH_USER: ${{ secrets.O2_SSH_USER }}
          O2_SSH_PORT: ${{ secrets.O2_SSH_PORT }}
          O2_TARGET_DIR: ${{ secrets.O2_TARGET_DIR }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          set -euo pipefail
          ssh -4 -p "${O2_SSH_PORT}" "${O2_SSH_USER}@${O2_SSH_HOST}" << EOF
          set -e
          cd "${O2_TARGET_DIR}"

          export DATABASE_URL="${DATABASE_URL}"

          npm ci --omit=dev
          npx prisma migrate deploy

          mkdir -p tmp
          touch tmp/restart.txt
          EOF
