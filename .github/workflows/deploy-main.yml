name: Deploy to o2switch (Next.js standalone + Prisma)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run type-check

      - name: Build (standalone)
        run: npm run build

      - name: Prepare deploy artifact (standalone only)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf deploy
          mkdir -p deploy

          # server.js wrapper (ensure present in repo OR generate here)
          if [ ! -f server.js ]; then
            cat > deploy/server.js <<'JS'
          const path = require("path");
          process.chdir(__dirname);
          require(path.join(__dirname, ".next", "standalone", "server.js"));
          JS
          else
            cp -f server.js deploy/server.js
          fi

          # Copy standalone output
          mkdir -p deploy/.next
          rsync -a .next/standalone/ deploy/.next/standalone/
          rsync -a .next/static/ deploy/.next/static/

          # Public assets (optional)
          if [ -d public ]; then
            rsync -a public/ deploy/public/
          fi

          # Prisma (needed for migrate deploy)
          if [ -d prisma ]; then
            rsync -a prisma/ deploy/prisma/
          fi

          # Minimal package files (useful for Prisma CLI / client)
          cp -f package.json deploy/
          if [ -f package-lock.json ]; then cp -f package-lock.json deploy/; fi

          # (Optional but useful) include next.config.js for trace/debug
          if [ -f next.config.js ]; then cp -f next.config.js deploy/; fi

          echo "Deploy content:"
          find deploy -maxdepth 3 -type f | sed -n '1,200p'

      - name: Install tools (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get runner public IP
        id: ip
        uses: haythem/public-ip@v1.3

      # --- garde tes steps Debug cPanel / port check / whitelist / reachability ---
      # (je ne les recopie pas ici pour rÃ©duire, mais tu les gardes identiques)

      - name: Wait for whitelist to be effective
        shell: bash
        env:
          O2_SSH_HOST: ${{ secrets.O2_HOST }}
          O2_SSH_USER: ${{ secrets.O2_USER }}
          O2_SSH_PORT: ${{ secrets.O2_SSH_PORT }}
          O2_SSH_KEY: ${{ secrets.O2_SSH_KEY }}
        run: |
          set -euo pipefail

          mkdir -p ~/.ssh
          printf '%s\n' "$O2_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

          for i in $(seq 1 30); do
            echo "SSH check attempt $i..."
            if ssh $SSH_OPTS -o BatchMode=yes -o ConnectTimeout=5 -p "$O2_SSH_PORT" \
              "$O2_SSH_USER@$O2_SSH_HOST" "echo OK" >/dev/null 2>&1; then
              echo "SSH is reachable."
              exit 0
            fi
            sleep 10
          done

          echo "SSH still not reachable after 5 min."
          exit 1

      - name: Deploy via rsync (standalone artifact)
        shell: bash
        env:
          O2_SSH_HOST: ${{ secrets.O2_HOST }}
          O2_SSH_USER: ${{ secrets.O2_USER }}
          O2_SSH_PORT: ${{ secrets.O2_SSH_PORT }}
          O2_TARGET_DIR: ${{ secrets.O2_TARGET_DIR }}
        run: |
          set -euo pipefail
          SSH_OPTS="-4 -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          rsync -az --delete \
            -e "ssh $SSH_OPTS -p ${O2_SSH_PORT}" \
            deploy/ \
            "${O2_SSH_USER}@${O2_SSH_HOST}:${O2_TARGET_DIR}/"

      - name: Prisma migrate + restart (server)
        shell: bash
        env:
          O2_SSH_HOST: ${{ secrets.O2_HOST }}
          O2_SSH_USER: ${{ secrets.O2_USER }}
          O2_SSH_PORT: ${{ secrets.O2_SSH_PORT }}
          O2_TARGET_DIR: ${{ secrets.O2_TARGET_DIR }}
          O2_NODEENV_ACTIVATE: ${{ secrets.O2_NODEENV_ACTIVATE }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          set -euo pipefail

          if [ -z "${DATABASE_URL:-}" ]; then
            echo "ERROR: DATABASE_URL secret is empty."
            exit 1
          fi

          DATABASE_URL_B64="$(printf '%s' "$DATABASE_URL" | base64 -w 0)"

          ssh -4 -i ~/.ssh/id_ed25519 \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -p "$O2_SSH_PORT" \
            "$O2_SSH_USER@$O2_SSH_HOST" \
            "export DATABASE_URL_B64='$DATABASE_URL_B64'; export O2_TARGET_DIR='$O2_TARGET_DIR'; export O2_NODEENV_ACTIVATE='$O2_NODEENV_ACTIVATE'; bash -s" <<'EOF'
          set -euo pipefail

          set +u
          source "$O2_NODEENV_ACTIVATE"
          set -u

          cd "$O2_TARGET_DIR"

          export DATABASE_URL="$(printf '%s' "$DATABASE_URL_B64" | base64 --decode)"

          echo "node: $(node -v) / npm: $(npm -v)"
          echo "Running prisma migrate deploy..."

          # Ensure prisma CLI exists in this environment
          # If prisma is a devDependency, force include=dev in your server-side install OR ensure Prisma is available.
          # Here: we do NOT npm ci on server; we rely on the nodevenv having deps OR prisma being in standalone bundle.
          # Safer: run via npx using local package.json (it will use installed deps from nodevenv)
          npx prisma migrate deploy

          mkdir -p tmp
          touch tmp/restart.txt

          echo "Deploy OK"
          EOF

      - name: Post-deploy sanity check (server)
        shell: bash
        env:
          O2_SSH_HOST: ${{ secrets.O2_HOST }}
          O2_SSH_USER: ${{ secrets.O2_USER }}
          O2_SSH_PORT: ${{ secrets.O2_SSH_PORT }}
          O2_TARGET_DIR: ${{ secrets.O2_TARGET_DIR }}
        run: |
          set -euo pipefail
          ssh -4 -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -p "$O2_SSH_PORT" "$O2_SSH_USER@$O2_SSH_HOST" \
            "bash -lc '
              set -e
              cd \"$O2_TARGET_DIR\"
              test -f server.js && echo \"server.js OK\" || (echo \"server.js missing\" && exit 1)
              test -f .next/standalone/server.js && echo \"standalone server OK\" || (echo \"standalone missing\" && exit 1)
              test -d .next/static && echo \"static OK\" || (echo \"static missing\" && exit 1)
            '"

      - name: Cleanup whitelist (remove runner IP)
        if: ${{ always() }}
        shell: bash
        env:
          CPANEL_HOST: ${{ secrets.CPANEL_HOST }}
          CPANEL_USER: ${{ secrets.CPANEL_USER }}
          CPANEL_PASSWORD: ${{ secrets.CPANEL_PASSWORD }}
          RUNNER_IP: ${{ steps.ip.outputs.ipv4 }}
        run: |
          set -euo pipefail
          ENDPOINT='frontend/o2switch/o2switch-ssh-whitelist/index.live.php'
          fetch() {
            curl -4 -sS --connect-timeout 10 --max-time 20 -u "${CPANEL_USER}:${CPANEL_PASSWORD}" \
              "https://${CPANEL_HOST}:2083/${ENDPOINT}?$1"
          }
          fetch "r=remove&address=${RUNNER_IP}&direction=in&port=22" || true
          fetch "r=remove&address=${RUNNER_IP}&direction=out&port=22" || true
